<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REDCap Dynamic Dashboard</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }
    .filter-section {
        margin-bottom: 20px;
    }
    .filter-section label {
        margin-right: 10px;
        font-weight: bold;
    }
    .filter-section input, .filter-section select {
        margin-right: 20px;
        padding: 5px;
    }
</style>
</head>
<body>
<h2>Dynamic REDCap Dashboard</h2>
<p>Filter data using REDCap fields and attributes.</p>

<div class="filter-section">
    <label for="practiceNameFilter">Practice Name:</label>
    <select id="practiceNameFilter">
        <option value="">All Practices</option>
    </select>
    <label for="fromDate">From Date:</label>
    <input type="date" id="fromDate">
    <label for="toDate">To Date:</label>
    <input type="date" id="toDate">
    <button onclick="applyFilters()">Apply Filters</button>
</div>

<table id="redcapTable" class="display" style="width:100%">
    <thead>
        <tr id="tableHeaders"></tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script type="text/javascript">
    const API_URL = "https://a816-health.nyc.gov/REDCap/api/"; // Replace with your REDCap API URL
    const API_TOKEN = "EF8D98075D2B481FE7E6E7318E81E127"; // Replace with your API token

    let fetchedData = []; // Holds the original data from REDCap

    // Mapping practice codes to names
    const practiceMapping = {
        "1": "Broadway Internal Medical",
        "2": "Corona Medical PC",
        "3": "Family Health NP Services, P.C.",
        "4": "Flatlands Medical-Urgent Care",
        "5": "Linden Family Medical Care P.C.",
        "6": "Marcia Morgan MD PC",
        "7": "Mergie Desir MD, P.L.L.C."
    };

    function fetchREDCapData() {
        $.ajax({
            url: API_URL,
            type: 'POST',
            data: {
                'token': API_TOKEN,
                'content': 'record',
                'format': 'json',
                'type': 'flat',
                'fields': 'practicename,record_creation_date' // Adjust fields as necessary
            },
            success: function(data) {
                fetchedData = data; // Store the original data
                populatePracticeNames(data);
                renderTable(data);
            },
            error: function(error) {
                console.error("Error fetching data from REDCap:", error);
                alert("Failed to retrieve data from REDCap.");
            }
        });
    }

    function populatePracticeNames(data) {
        const uniquePractices = [...new Set(data.map(record => practiceMapping[record.practicename] || "Unknown"))];
        uniquePractices.forEach(practice => {
            $("#practiceNameFilter").append(`<option value="${practice}">${practice}</option>`);
        });
    }

    function renderTable(data) {
        $("#tableHeaders").empty();
        $("#tableBody").empty();

        if (data.length === 0) {
            alert("No data found.");
            return;
        }

        let headers = Object.keys(data[0]);
        headers.forEach(header => {
            $("#tableHeaders").append(`<th>${header}</th>`);
        });

        data.forEach(record => {
            let row = '<tr>';
            headers.forEach(header => {
                row += `<td>${record[header] || ""}</td>`;
            });
            row += '</tr>';
            $("#tableBody").append(row);
        });

        $('#redcapTable').DataTable({
            destroy: true // Allow reinitialization for filtered data
        });
    }

    function applyFilters() {
        const practiceFilter = $("#practiceNameFilter").val();
        const fromDate = $("#fromDate").val();
        const toDate = $("#toDate").val();

        const filteredData = fetchedData.filter(record => {
            const matchesPractice = !practiceFilter || practiceMapping[record.practicename] === practiceFilter;
            const recordDate = new Date(record.record_creation_date || ""); // Adjust field name if necessary
            const matchesDate =
                (!fromDate || recordDate >= new Date(fromDate)) &&
                (!toDate || recordDate <= new Date(toDate));
            return matchesPractice && matchesDate;
        });

        renderTable(filteredData);
    }

    $(document).ready(function() {
        fetchREDCapData();
    });
</script>
</body>
</html>
